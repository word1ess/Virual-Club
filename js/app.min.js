const videoFromStories = Array.from(
  document.querySelectorAll(".js-stories-collection__video")
).map(
  (video) =>
    new Plyr(video, {
      title: "VR",
      controls: [],
      volume: 0,
      muted: true,
      autoplay: true,
    })
);

videoFromStories.forEach((video) => {
  video.muted = true;
  video.on("ready", () => {
    video.restart();
    video.play();
    video.on("playing", timerForVideo(video, video.duration));
  });
  setTimeout(() => {}, video.duration * 1000);
});

function timerForVideo(video, duration) {
  let timeLimit = duration;
  let timePassed = 0;
  let timeLeft = timeLimit;
  console.log(video.duration);

  const timerInterval = setInterval(() => {
    timePassed = timePassed += 1;
    timeLeft = timeLimit - timePassed;
    setCircleDasharray();
  }, 1000);
  function calculateTimeFraction() {
    const rawTimeFraction = timeLeft / timeLimit;
    return rawTimeFraction - (1 / timeLimit) * (1 - rawTimeFraction);
  }
  function setCircleDasharray() {
    let circleDasharray = `${(250 * calculateTimeFraction()).toFixed(0)} 283`;
    if (283 * calculateTimeFraction() < 0) {
      circleDasharray = `0 283`;
      document.getElementById("js-stories-collection__timer").innerHTML = ``;
      return;
    }
    document
      .getElementById("base-timer-path-remaining")
      .setAttribute("stroke-dasharray", circleDasharray);
  }
  document.getElementById("js-stories-collection__timer").innerHTML = `
      <div class="base-timer">
        <svg class="base-timer__svg" viewBox="0 0 105 100" xmlns="http://www.w3.org/2000/svg">
          <g class="base-timer__circle">
            <path id="base-timer-path-remaining" stroke-dasharray="283" class="base-timer__path-remaining"
              d=" 
                M 50, 50
                m -45, 0
                a 45,45 0 1,0 90,0
                a 45,45 0 1,0 -90,0"></path>
          </g>
        </svg>
      </div>`;
  if (window.screen.width < 1500) {
    document.getElementById("js-stories-collection__timer").innerHTML = `
      <div class="base-timer">
        <svg class="base-timer__svg" viewBox="0 0 96 100" xmlns="http://www.w3.org/2000/svg">
          <g class="base-timer__circle">
            <path id="base-timer-path-remaining" stroke-dasharray="283" class="base-timer__path-remaining"
              d=" M 50, 50
                m -45, 0
                a 45,45 0 1,0 90,0
                a 45,45 0 1,0 -90,0"></path>
          </g>
        </svg>
      </div>`;
  }
  if (window.screen.width < 1280) {
    document.getElementById("js-stories-collection__timer").innerHTML = `
      <div class="base-timer">
        <svg class="base-timer__svg" viewBox="0 0 78 100" xmlns="http://www.w3.org/2000/svg">
          <g class="base-timer__circle">
            <path id="base-timer-path-remaining" stroke-dasharray="283" class="base-timer__path-remaining"
              d=" M 50, 50
                m -45, 0
                a 45,45 0 1,0 90,0
                a 45,45 0 1,0 -90,0"></path>
          </g>
        </svg>
      </div>`;
  }
  video.off("playing", timerForVideo);
}

if (videoFromStories[0]) {
  for (let i = 0; i < videoFromStories.length; i++) {
    let duration = videoFromStories[i].duration;
    videoFromStories[0].play();
    setTimeout(() => {}, duration * 1000);
  }
}

class SlideStories {
  constructor(id, activeSlide) {
    this.slide = document.querySelector(`[data-slide="${id}"]`);
    this.active = 0;
    this.init(activeSlide);
  }
  activeSlide(index) {
    this.active = index;
    this.items.forEach((item) => item.classList.remove("active"));
    this.items[index].classList.add("active");
    this.thumbItems.forEach((item) => item.classList.remove("active"));
    this.thumbItems[index].classList.add("active");
    this.autoSlide();
  }
  prev() {
    if (this.active > 0) {
      this.activeSlide(this.active - 1);
    } else {
      this.activeSlide(this.items.length - 1);
    }
  }
  next() {
    if (this.active < this.items.length - 1) {
      this.activeSlide(this.active + 1);
    } else {
      this.activeSlide(0);
    }
  }
  addNavigation() {
    const nextBtnArrow = this.slide.querySelector(
      ".stories-slider__slide-arrow-next"
    );
    const prevBtnArrow = this.slide.querySelector(
      ".stories-slider__slide-arrow-prev"
    );
    const nextBtn = this.slide.querySelector(".stories-slider__slide-next");
    const prevBtn = this.slide.querySelector(".stories-slider__slide-prev");
    nextBtn.addEventListener("click", this.next);
    prevBtn.addEventListener("click", this.prev);
    nextBtnArrow.addEventListener("click", this.next);
    prevBtnArrow.addEventListener("click", this.prev);
  }
  addThumbItems() {
    this.items.forEach(() => (this.thumb.innerHTML += `<span></span>`));
    this.thumbItems = Array.from(this.thumb.children);
  }
  autoSlide() {
    clearTimeout(this.timeout);
    this.timeout = setTimeout(this.next, 5000);
  }
  init(activeSlide) {
    this.next = this.next.bind(this);
    this.prev = this.prev.bind(this);
    this.items = this.slide.querySelectorAll(
      ".stories-slider__slide-items > *"
    );
    this.thumb = this.slide.querySelector(".stories-slider__slide-thumb");
    this.addThumbItems();
    this.activeSlide(activeSlide);
    this.addNavigation();
  }
}

const storiesItems = Array.from(
  document.querySelectorAll(".js-stories-collection")
);
const sliderContainer = document.querySelector("#js-stories-slider__controls");
const slider = document.querySelector("#js-stories-slider__slide-items");
const slideThumbs = document.querySelector(".js-stories-slider__slide-thumb");
storiesItems.forEach((story) => {
  story.addEventListener("click", createSotiresSLider);
});

function createSotiresSLider(e) {
  let index = storiesItems.indexOf(this);
  slider.parentNode.classList.add("active");
  sliderContainer.classList.add("active");
  storiesItems.forEach((story) => {
    let cloneStory = story.cloneNode(true);
    let removedChild = cloneStory.querySelector(
      ".js-stories-collection__stories"
    );
    removedChild.parentNode.removeChild(removedChild);
    cloneStory.appendChild(createElementsForStory(removedChild, cloneStory));
    slider.appendChild(cloneStory.cloneNode(true));
  });
  new SlideStories("stories-slider__slide", index);
  sliderContainer.addEventListener("click", removeSlider);
}
function createElementsForStory(parent, container) {
  let fragment = document.createDocumentFragment();
  let title = document.createElement("h3");
  title.classList.add("stories-story__title");
  title.textContent = parent.querySelector(
    ".js-stories-story__title"
  ).innerHTML;

  let subtitle = document.createElement("h4");
  subtitle.classList.add("stories-story__text");
  subtitle.textContent = parent.querySelector(
    ".js-stories-story__text"
  ).innerHTML;
  fragment.appendChild(title);
  fragment.appendChild(subtitle);

  if (parent.querySelector(".js-stories-story__product-slide")) {
    let slider = document.createElement("DIV");
    let sliderWrapper = document.createElement("DIV");
    let sliderLeftArrow = document.createElement("DIV");
    let sliderRightArrow = document.createElement("DIV");
    let contentForStories = Array.from(
      parent.querySelectorAll(".js-stories-story__product-slide")
    );

    slider.classList.add("products-slider", "swiper");
    sliderWrapper.classList.add("swiper-wrapper");
    sliderLeftArrow.classList.add("products-slider-prev", "swiper-button-prev");
    sliderRightArrow.classList.add(
      "products-slider-next",
      "swiper-button-next"
    );
    for (let i = 0; i != contentForStories.length; i++) {
      let sliderItem = document.createElement("DIV");
      let sliderImg = document.createElement("DIV");
      let sliderContent = document.createElement("DIV");
      let sliderBottom = document.createElement("DIV");
      let sliderPriceContainer = document.createElement("DIV");
      let sliderButtonPrev = document.createElement("DIV");
      let sliderButtonNext = document.createElement("DIV");

      sliderItem.classList.add("products-slider__item", "swiper-slide");
      sliderButtonPrev.classList.add("swiper-button-prev");
      sliderButtonNext.classList.add("swiper-button-next");
      sliderImg.classList.add("products-slider__img");
      sliderContent.classList.add("products-slider__content");
      sliderBottom.classList.add("products-slider__bottom");
      sliderPriceContainer.classList.add("products-slider__prices");

      let sliderContentTitle = document.createElement("h3");
      let sliderOldPrice = document.createElement("p");
      let sliderNewPrice = document.createElement("p");
      let sliderCart = document.createElement("button");
      let sliderImgProduct = document.createElement("img");
      sliderContentTitle.textContent = contentForStories[i].querySelector(
        ".stories-story__product-slide__title"
      ).innerHTML;
      sliderOldPrice.textContent = contentForStories[i].querySelector(
        ".stories-story__product-slide__price-old"
      ).innerHTML;
      sliderNewPrice.textContent = contentForStories[i].querySelector(
        ".stories-story__product-slide__price-new"
      ).innerHTML;
      sliderImgProduct.src = contentForStories[i].querySelector("img").src;

      sliderContentTitle.classList.add("stories-story__product-slide__title");
      sliderOldPrice.classList.add("stories-story__product-slide__price-old");
      sliderNewPrice.classList.add("stories-story__product-slide__price-new");
      sliderCart.classList.add("products-slider__cart");

      sliderPriceContainer.appendChild(sliderOldPrice);
      sliderPriceContainer.appendChild(sliderNewPrice);

      sliderBottom.appendChild(sliderPriceContainer);
      sliderBottom.appendChild(sliderCart);

      sliderContent.appendChild(sliderContentTitle);
      sliderContent.appendChild(sliderBottom);

      sliderImg.appendChild(sliderImgProduct);

      sliderItem.appendChild(sliderImg);
      sliderItem.appendChild(sliderContent);

      sliderWrapper.appendChild(sliderItem);
    }

    slider.appendChild(sliderWrapper);
    slider.appendChild(sliderLeftArrow);
    slider.appendChild(sliderRightArrow);
    fragment.appendChild(slider);
    const swiper = new Swiper(".products-slider", {
      loop: true,
      slidesPerView: 1.2,
      direction: "horizontal",
      spaceBetween: 4,
      navigation: {
        prevEl: ".products-slider-prev",
        nextEl: ".products-slider-next",
      },
    });
  } else {
    container.classList.add("text-bottom");
  }
  return fragment;
}
function removeSlider(e) {
  if (e.target.classList.contains("stories-slider__controls")) {
    sliderContainer.classList.remove("active");
    slider.innerHTML = "";
    slideThumbs.innerHTML = "";
  }
}

if ($(".js-products-cards-slider").length > 0) {
  $(".js-products-cards-slider").each(function () {
    var self = $(this);
    initProductCardSlider(self);
  });
}
function initProductCardSlider(self) {
  self.slick({
    infinite: true,
    slidesToScroll: 5,
    slidesToShow: 5,
    dots: true,
    appendDots: self
      .closest(".products-cards-slider__wrapper")
      .find(".js-products-cards-slider-pagination"),
    prevArrow: self
      .closest(".products-cards-slider__wrapper")
      .find(".js-products-cards-slider-btn-prev"),
    nextArrow: self
      .closest(".products-cards-slider__wrapper")
      .find(".js-products-cards-slider-btn-next"),
    responsive: [
      {
        breakpoint: 1550,
        settings: {
          slidesToScroll: 5,
          slidesToShow: 5,
        },
      },
      {
        breakpoint: 1368,
        settings: {
          slidesToScroll: 4,
          slidesToShow: 4,
        },
      },
      {
        breakpoint: 1200,
        settings: {
          slidesToScroll: 3,
          slidesToShow: 3,
        },
      },
      {
        breakpoint: 992,
        settings: {
          slidesToShow: 2,
          slidesToScroll: 2,
        },
      },
    ],
  });
}
